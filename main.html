<!DOCTYPE html>
<html>
<head>
	<title>Cirix</title>
	<script src='https://code.jquery.com/jquery-3.2.1.js' integrity='sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=' crossorigin='anonymous'></script>
	<link href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css' rel='stylesheet' integrity='sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M' crossorigin='anonymous'>
</head>
<body>
<div id='container'>
	<div class='row'>
	<div class='col-6'>
		<table class='table'>
			<thead class='thead-inverse'>
				<tr>
					<th>New</th>
					<th>Ready</th>
					<th>Running</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><select multiple id='new' class='form-control'></select></td>
					<td><select multiple id='ready' class='form-control'></select></td>
					<td><select multiple id='running' class='form-control'></select></td>
				</tr>
			</tbody>
		</table>
	</div>
	</div>

	<div class='row'>
	<div class='col-6'>
		<table class='table'>
			<thead class='thead-inverse'>
				<tr>
					<th width='33%'>Waiting for I/O</th>
					<th width='33%'>Using I/O</th>
					<th width='33%'>Finished</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td><select multiple id='io_waiting' class='form-control'></select></td>
					<td><select multiple id='io_using' class='form-control'></select></td>
					<td><select multiple id='finished' class='form-control'></select></td>
				</tr>
			</tbody>
		</table>
	</div>
	</div>

	CPU Cycle:<div id='cpu_cycle'></div>
	Quantum:<div id='quantum'></div>
	<input type='number' id='clock_speed'><br><br>
	<input type='number' id='luck'><br><br>
	<button onclick='pause()' id='pause'>Start</button>
	<button onclick='reset()' id='reset'>Reset</button>
	<table id='pcb'>
		<tr>
			<th>Name</th>
			<th>Arrival time</th>
			<th>Processor want</th>
			<th>Processor used</th>
			<th>I/O trigger</th>
			<th>I/O want</th>
			<th>I/O used</th>
		</tr>
	</table>
</div>
<script type='text/javascript'>
	window.onload = function() {
		set_default_settings();
		loop();
	};

	pause = function() {
		state.paused = !state.paused;

		if(state.paused) {
			$('#pause').text('Start');
		}
		else {
			$('#pause').text('Pause');
			loop();
		}
	}

	var state = {
		cpu_cycle : 1,
		quantum : 1,
		process_count : 0,
		paused : true,
		lists : {
			new : [],
			ready : [],
			running : [],
			io_using : [],
			io_waiting : [],
			finished : []
		}
	}

	var default_settings = {
		clock_speed : 200,
		quantum : 6,
		luck : 100
	}

	var current_settings = {
		clock_speed : null,
		quantum : null,
		luck : null
	}

	var ui_display = ['cpu_cycle', 'quantum', 'luck'];

	user_process = function(name, arrival_time, processor_want, io_want, io_trigger) {
		this.name = name;
		this.arrival_time = arrival_time;
		this.processor_want = processor_want;
		this.processor_used = 0;
		this.io_want = io_want;
		this.io_used = 0;
		this.io_trigger = io_trigger;
	}

	set_default_settings = function() {
		for(let key in default_settings) {
			$('#' + key).val(default_settings[key]);
		}
	}

	read_settings = function() {
		for(let key in current_settings) {
			current_settings[key] = $('#' + key).val();
		}

		for(let key in ui_display) {
			$('#' + ui_display[key]).text(state[ui_display[key]]);
		}
	}

	randomly_generate_process = function() {
		if(Math.floor(Math.random() * 100) + 1 < current_settings.luck) {
			let new_process = new user_process(get_name(), state.cpu_cycle, 10, 10, 2);
			state.lists.new.push(new_process);
			state.process_count++;
		}
	}

	refresh_lists = function() {
		let pcb = [];

		$('#pcb').empty();
		$('#pcb').append('<tr><th>Name</th><th>Arrival time</th><th>Processor want</th><th>Processor used</th><th>I/O trigger</th><th>I/O want</th><th>I/O used</th></tr>')
		for(let key in state.lists) {
			$('#' + key).empty();
		}

		for(let key in state.lists) {
			for(let i in state.lists[key]) {
				$('#' + key).append($('<option>', {
					text: state.lists[key][i].name + ' ' + state.lists[key][i].processor_used + '   ' + state.lists[key][i].io_used
				}));

				pcb.push(state.lists[key][i]);
			}
		}

		pcb.sort(function(a, b) {
			if(a.name < b.name) {
				return -1;
			}
			
			if(a.name > b.name) {
				return 1;
			}

			return 0;
		});

		for(let i in pcb) {
			$('#pcb').append('<tr><th>' + pcb[i].name + '</th><th>' + pcb[i].arrival_time + '</th><th>' + pcb[i].processor_want + '</th><th>' + pcb[i].processor_used + '</th><th>' + pcb[i].io_trigger + '</th><th>' + pcb[i].io_want + '</th><th>' + pcb[i].io_used + '</th></tr>');
		}
	}

	get_name = function(n) {
		let output = state.process_count + '';
		while(output.length < 3) {
			output = '0' + output;
		}

		return 'PROC' + output;
	}

	tick = function() {
		state.cpu_cycle++

		state.quantum++;
		if(state.quantum > current_settings.quantum) {
			state.quantum = 0;
		}

		if(state.lists.io_using.length != 0) {
			if(state.lists.io_using[0].io_used < state.lists.io_using[0].io_want) {
				state.lists.io_using[0].io_used++;
			}
		}
	}

	move = function(target, destination, destination_empty = false) {
		if(destination_empty && state.lists[destination].length != 0) {
			return;
		}

		if(state.lists[target].length != 0) {
			console.log('Moved ' + state.lists[target][0].name + ' from ' + target + ' to ' + destination);
			state.lists[destination].push(state.lists[target].shift());
		}
	}

	move_exhaust = function(target, destination, destination_empty = false) {
		if(destination_empty && state.lists[destination].length != 0) {
			return;
		}

		while(state.lists[target].length != 0) {
			console.log('Moved ' + state.lists[target][0].name + ' from ' + target + ' to ' + destination);
			state.lists[destination].push(state.lists[target].shift());
		}
	}

	interrupt = function() {
		move_exhaust('new', 'ready');
		if(state.lists.running.length != 0) {
			let running_process = state.lists.running[0];
			if(running_process.processor_used == running_process.processor_want) {
				move('running', 'finished');
			}

			if(running_process.io_trigger == running_process.processor_used) {
				move('running', 'io_waiting');
			}
		}

		move('running', 'ready');
		move('ready', 'running', true);

		if(state.lists.io_using.length != 0) {
			let io_process = state.lists.io_using[0];

			if(io_process.io_used == io_process.io_want) {
				if(io_process.processor_used == io_process.processor_want) {
					move('io_using', 'finished');
				}
				else {
					move('io_using', 'ready');
				}
			}
		}

		move('io_waiting', 'io_using', true);
		move('ready', 'running', true);
	}

	reset = function() {
		location.reload();
	}

	forward = function() {
		if(state.lists.running.length != 0) {
			let running_process = state.lists.running[0];
			running_process.processor_used++;

			if(running_process.processor_used == running_process.processor_want) {
				state.quantum = -1;
			}

			if(running_process.io_trigger == running_process.processor_used) {
				state.quantum = -1;
			}

		}
	}

	handle = function() {
		if(state.quantum == 0) {
			interrupt();
		}
		else {
			forward();
		}
	}

	loop = function() {
		if(state.paused) {
			return;
		}

		read_settings();
		randomly_generate_process();
		handle();
		refresh_lists();

		tick();
		if(!state.paused) {
			setTimeout(loop, current_settings.clock_speed);
		}
	}
</script>
</body>
</html>